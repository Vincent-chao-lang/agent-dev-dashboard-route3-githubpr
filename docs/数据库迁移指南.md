# æ•°æ®åº“è¿ç§»æŒ‡å—

æœ¬æ–‡æ¡£è¯´æ˜å¦‚ä½•é€‰æ‹©å’Œä½¿ç”¨æ•°æ®åº“ï¼Œä»¥åŠå¦‚ä½•åœ¨éœ€è¦æ—¶è¿›è¡Œè¿ç§»ã€‚

## ğŸ“‹ æ¦‚è¿°

ç³»ç»Ÿä½¿ç”¨ **SQLAlchemy** ä½œä¸ºæ•°æ®åº“æŠ½è±¡å±‚ï¼Œæ”¯æŒï¼š

- **SQLite** - å¼€å‘ç¯å¢ƒï¼ˆé»˜è®¤ï¼‰ï¼Œé›¶é…ç½®
- **PostgreSQL** - ç”Ÿäº§ç¯å¢ƒï¼ˆæ¨èï¼‰ï¼Œé«˜å¹¶å‘

### æ•°æ®åº“é€‰æ‹©æŒ‡å—

| åœºæ™¯ | æ¨èæ•°æ®åº“ | è¯´æ˜ |
|------|-----------|------|
| ğŸ  ä¸ªäººå¼€å‘ | SQLite | é›¶é…ç½®ï¼Œå¼€ç®±å³ç”¨ |
| ğŸ‘¥ å°å›¢é˜Ÿï¼ˆ< 10 äººï¼‰ | SQLite | ç®€å•éƒ¨ç½²ï¼Œè¶³å¤Ÿä½¿ç”¨ |
| ğŸ¢ ç”Ÿäº§ç¯å¢ƒ | PostgreSQL | é«˜å¹¶å‘ï¼Œæ•°æ®å®‰å…¨ |
| ğŸš€ SaaS æœåŠ¡ | PostgreSQL | ä¼ä¸šçº§æ”¯æŒ |
| ğŸ”„ éœ€è¦è¿ç§» | SQLite â†’ PostgreSQL | å‚é˜…ä¸‹æ–¹è¿ç§»ç« èŠ‚ |

### ä¸ºä»€ä¹ˆ PostgreSQL é€‚åˆç”Ÿäº§ï¼Ÿ

| ç‰¹æ€§ | SQLite | PostgreSQL |
|------|--------|------------|
| å¹¶å‘å†™å…¥ | å•å†™å…¥è€… | å¤šå†™å…¥è€… |
| ç½‘ç»œè®¿é—® | ä¸æ”¯æŒ | åŸç”Ÿæ”¯æŒ |
| æ•°æ®ç±»å‹ | åŸºç¡€ç±»å‹ | JSONã€æ•°ç»„ç­‰ä¸°å¯Œç±»å‹ |
| å…¨æ–‡æœç´¢ | æœ‰é™ | å¼ºå¤§ |
| å¤‡ä»½æ¢å¤ | æ–‡ä»¶å¤åˆ¶ | çƒ­å¤‡ä»½ã€PITR |
| ç”Ÿäº§æ”¯æŒ | ä¸æ¨è | ä¼ä¸šçº§æ”¯æŒ |

---

## ğŸš€ æ–°é¡¹ç›®ï¼šç›´æ¥ä½¿ç”¨ PostgreSQL

**æœ€ä½³å®è·µ**ï¼šæ–°é¡¹ç›®ç›´æ¥ä½¿ç”¨ PostgreSQLï¼Œæ— éœ€ä»»ä½•è¿ç§»ã€‚

### æ­¥éª¤ 1ï¼šåˆ›å»ºæ•°æ®åº“

```bash
# ä½¿ç”¨ psql åˆ›å»ºæ•°æ®åº“
createdb agent_dashboard

# æˆ–ä½¿ç”¨ SQL
psql -U postgres
CREATE DATABASE agent_dashboard;
CREATE USER agent_dashboard WITH PASSWORD 'your_secure_password';
GRANT ALL PRIVILEGES ON DATABASE agent_dashboard TO agent_dashboard;
\q
```

### æ­¥éª¤ 2ï¼šé…ç½®ç¯å¢ƒå˜é‡

```bash
# .env
DATABASE_URL=postgresql://agent_dashboard:your_password@localhost:5432/agent_dashboard
WORKSPACE_DIR=/data/workspace
SESSION_SECRET=strong-random-secret-here
```

### æ­¥éª¤ 3ï¼šå®‰è£…é©±åŠ¨å¹¶å¯åŠ¨

```bash
# å®‰è£… PostgreSQL é©±åŠ¨
pip install psycopg2-binary

# å¯åŠ¨åº”ç”¨ï¼ˆé¦–æ¬¡å¯åŠ¨è‡ªåŠ¨åˆ›å»ºæ‰€æœ‰è¡¨ï¼‰
uvicorn app.main:app --port 8787
```

**å°±è¿™ä¹ˆç®€å•ï¼** ç³»ç»Ÿä¼šè‡ªåŠ¨åˆ›å»º 16 ä¸ªè¡¨åŠæ‰€æœ‰å¤–é”®çº¦æŸã€‚

---

## ğŸ”„ ä» SQLite è¿ç§»åˆ° PostgreSQL

**ä»…åœ¨ä»¥ä¸‹æƒ…å†µéœ€è¦è¿ç§»**ï¼š
- å·²ç»åœ¨ä½¿ç”¨ SQLiteï¼Œæœ‰æ•°æ®éœ€è¦ä¿ç•™
- éœ€è¦ä»å¼€å‘ç¯å¢ƒå‡çº§åˆ°ç”Ÿäº§ç¯å¢ƒ

### åœºæ™¯ 1ï¼šæ•°æ®å¯ä¸¢å¼ƒï¼ˆå¼€å‘é˜¶æ®µï¼‰

**æœ€ç®€å•çš„æ–¹å¼**ï¼š
1. é…ç½® `DATABASE_URL` æŒ‡å‘ PostgreSQL
2. å¯åŠ¨åº”ç”¨ï¼Œç³»ç»Ÿè‡ªåŠ¨åˆ›å»ºè¡¨ç»“æ„
3. é‡æ–°åˆ›å»ºé¡¹ç›®å’Œç”¨æˆ·

```bash
# è®¾ç½®ç¯å¢ƒå˜é‡
export DATABASE_URL="postgresql://user:pass@host:5432/db"

# å¯åŠ¨åº”ç”¨ï¼ˆè‡ªåŠ¨åˆ›å»ºè¡¨ï¼‰
uvicorn app.main:app --reload
```

### åœºæ™¯ 2ï¼šéœ€è¦ä¿ç•™æ•°æ®ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰

**ä½¿ç”¨ pgloader è¿ç§»**ï¼š

```bash
# å®‰è£… pgloader
brew install pgloader  # macOS
# apt-get install pgloader  # Ubuntu

# è¿ç§»æ•°æ®
pgloader sqlite:///path/to/dashboard.sqlite \
          postgresql://user:pass@host:5432/agent_dashboard
```

**æ‰‹åŠ¨è¿ç§»æ­¥éª¤**ï¼š

1. **å¯¼å‡º SQLite æ•°æ®**ï¼š
```bash
# å¯¼å‡ºä¸º SQL
sqlite3 dashboard.sqlite .dump > dump.sql

# æˆ–å¯¼å‡ºä¸º CSV
for table in users projects slices; do
    sqlite3 dashboard.sqlite ".headers on" ".mode csv" ".output $table.csv" "SELECT * FROM $table"
done
```

2. **å¯¼å…¥åˆ° PostgreSQL**ï¼š
```bash
# è°ƒæ•´ SQL è¯­æ³•ï¼ˆSQLite â†’ PostgreSQLï¼‰
sed -i 's/AUTOINCREMENT/SERIAL/g' dump.sql
sed -i 's/INTEGER PRIMARY KEY/SERIAL PRIMARY KEY/g' dump.sql

# å¯¼å…¥
psql -U agent_dashboard -d agent_dashboard -f dump.sql
```

3. **éªŒè¯æ•°æ®**ï¼š
```bash
psql -U agent_dashboard -d agent_dashboard -c "SELECT COUNT(*) FROM users;"
psql -U agent_dashboard -d agent_dashboard -c "SELECT COUNT(*) FROM projects;"
```

---

## ğŸ³ éƒ¨ç½²é€‰é¡¹

### Docker Composeï¼ˆæ¨èç”¨äºæœ¬åœ°æµ‹è¯•ï¼‰

```yaml
# docker-compose.yml
version: '3.8'

services:
  app:
    build: .
    ports:
      - "8787:8787"
    environment:
      - DATABASE_URL=postgresql://agent_dashboard:secret@postgres:5432/agent_dashboard
    depends_on:
      - postgres

  postgres:
    image: postgres:16-alpine
    environment:
      - POSTGRES_USER=agent_dashboard
      - POSTGRES_PASSWORD=secret
      - POSTGRES_DB=agent_dashboard
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

volumes:
  postgres_data:
```

å¯åŠ¨ï¼š
```bash
docker-compose up -d
```

### äº‘æœåŠ¡ï¼ˆæ¨èç”¨äºç”Ÿäº§ï¼‰

**Supabase**ï¼š
1. åˆ›å»ºé¡¹ç›®ï¼šhttps://supabase.com
2. è·å– Connection Stringï¼ˆURI æ ¼å¼ï¼‰
3. å¤åˆ¶åˆ° `.env` çš„ `DATABASE_URL`

**Railway**ï¼š
1. åˆ›å»º PostgreSQL æ•°æ®åº“
2. è·å– Connection URL
3. æ·»åŠ åˆ°ç¯å¢ƒå˜é‡

**Neon**ï¼ˆServerless PostgreSQLï¼‰ï¼š
1. åˆ›å»ºé¡¹ç›®ï¼šhttps://neon.tech
2. è·å– Connection String
3. é…ç½®åˆ°ç¯å¢ƒå˜é‡

---

## ğŸ”§ é…ç½®ä¼˜åŒ–

### PostgreSQL è¿æ¥æ± é…ç½®

**ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½®**ï¼š

```bash
# .env
DATABASE_URL=postgresql://user:pass@host:5432/db
DB_POOL_SIZE=10          # è¿æ¥æ± å¤§å°
DB_MAX_OVERFLOW=20       # æœ€å¤§æº¢å‡ºè¿æ¥æ•°
MAX_WORKERS=20           # åå°å·¥ä½œçº¿ç¨‹æ•°
```

**è®¡ç®—å…¬å¼**ï¼š
```
DB_POOL_SIZE = MAX_WORKERS / 2
DB_MAX_OVERFLOW = MAX_WORKERS
```

### PostgreSQL ä¼˜åŒ–å‚æ•°

**ç¼–è¾‘ `postgresql.conf`**ï¼š

```ini
# å†…å­˜ç›¸å…³
shared_buffers = 256MB
effective_cache_size = 1GB
maintenance_work_mem = 64MB

# è¿æ¥ç›¸å…³
max_connections = 100

# WAL ç›¸å…³
wal_buffers = 16MB
checkpoint_completion_target = 0.9
```

---

## ğŸ§ª éªŒè¯è¿ç§»

### 1. æ£€æŸ¥è¡¨ç»“æ„

```bash
psql -U agent_dashboard -d agent_dashboard -c "\dt"
```

åº”è¯¥çœ‹åˆ°æ‰€æœ‰ 16 ä¸ªè¡¨ï¼š
```
 users | projects | project_members | slices | ...
```

### 2. æ£€æŸ¥å¤–é”®çº¦æŸ

```bash
psql -U agent_dashboard -d agent_dashboard -c "\d+ slices"
```

åº”è¯¥çœ‹åˆ°ï¼š
```
Foreign-key constraints:
    "slices_project_id_fkey" FOREIGN KEY (project_id) REFERENCES projects(id) ON DELETE CASCADE
    "slices_created_by_user_id_fkey" FOREIGN KEY (created_by_user_id) REFERENCES users(id) ON DELETE CASCADE
```

### 3. è¿è¡Œåº”ç”¨æµ‹è¯•

```bash
# å¯åŠ¨åº”ç”¨
uvicorn app.main:app --port 8787

# æµ‹è¯•ç™»å½•
curl -X POST http://localhost:8787/api/login \
  -H "Content-Type: application/json" \
  -d '{"username":"test","password":"test"}'

# åˆ›å»ºé¡¹ç›®
curl -X POST http://localhost:8787/api/projects \
  -H "Cookie: session=..." \
  -H "Content-Type: application/json" \
  -d '{"name":"test","repo_url":"...","default_branch":"main"}'
```

---

## ğŸ”’ å®‰å…¨å»ºè®®

### 1. ä½¿ç”¨ç¯å¢ƒå˜é‡

**âŒ ä¸è¦**ï¼š
```python
DATABASE_URL = "postgresql://user:password@..."
```

**âœ… åº”è¯¥**ï¼š
```bash
# .envï¼ˆä¸æäº¤åˆ° Gitï¼‰
DATABASE_URL=postgresql://user:password@...
```

### 2. SSL è¿æ¥ï¼ˆç”Ÿäº§ç¯å¢ƒï¼‰

```bash
# å¼ºåˆ¶ SSL
DATABASE_URL=postgresql://user:pass@host:5432/db?sslmode=require

# éªŒè¯è¯ä¹¦
DATABASE_URL=postgresql://user:pass@host:5432/db?sslmode=verify-full
```

### 3. æœ€å°æƒé™åŸåˆ™

```sql
-- åªç»™åº”ç”¨å¿…è¦çš„æƒé™
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO agent_dashboard;
GRANT USAGE, SELECT ON ALL SEQUENCES IN SCHEMA public TO agent_dashboard;
```

---

## ğŸ“Š ç›‘æ§ä¸ç»´æŠ¤

### æ…¢æŸ¥è¯¢æ—¥å¿—

```sql
-- postgresql.conf
log_min_duration_statement = 1000  -- è®°å½•è¶…è¿‡ 1 ç§’çš„æŸ¥è¯¢
```

### æ•°æ®åº“å¤§å°ç›‘æ§

```sql
-- æŸ¥çœ‹æ•°æ®åº“å¤§å°
SELECT pg_size_pretty(pg_database_size('agent_dashboard'));

-- æŸ¥çœ‹è¡¨å¤§å°
SELECT
    relname AS table_name,
    pg_size_pretty(pg_total_relation_size(relid)) AS size
FROM pg_catalog.pg_statio_user_tables
ORDER BY pg_total_relation_size(relid) DESC;
```

### å®šæœŸå¤‡ä»½

```bash
# æ¯æ—¥å¤‡ä»½
0 2 * * * pg_dump -U agent_dashboard agent_dashboard | gzip > /backups/db_$(date +\%Y\%m\%d).sql.gz

# ä¿ç•™æœ€è¿‘ 7 å¤©
find /backups -name "db_*.sql.gz" -mtime +7 -delete
```

---

## â“ å¸¸è§é—®é¢˜

### Q1: å¯åŠ¨æ—¶æç¤º "relation does not exist"

**åŸå› **ï¼šè¡¨æœªåˆ›å»º

**è§£å†³**ï¼š
```python
# ç¡®ä¿åº”ç”¨å¯åŠ¨æ—¶è°ƒç”¨äº† init_db()
from app.db import init_db
init_db()
```

### Q2: PostgreSQL è¿æ¥è¢«æ‹’ç»

**æ£€æŸ¥æ¸…å•**ï¼š
1. PostgreSQL æ˜¯å¦è¿è¡Œï¼Ÿ
```bash
sudo systemctl status postgresql
```

2. é˜²ç«å¢™æ˜¯å¦å¼€æ”¾ï¼Ÿ
```bash
sudo ufw allow 5432/tcp
```

3. `pg_hba.conf` æ˜¯å¦å…è®¸è¿æ¥ï¼Ÿ
```
host    all    all    0.0.0.0/0    md5
```

### Q3: å­—ç¬¦ç¼–ç é”™è¯¯

**ç¡®ä¿æ•°æ®åº“ä½¿ç”¨ UTF-8**ï¼š
```sql
CREATE DATABASE agent_dashboard
  ENCODING 'UTF8'
  LC_COLLATE='en_US.UTF-8'
  LC_CTYPE='en_US.UTF-8'
  TEMPLATE=template0;
```

### Q4: è¿ç§»å ID åºåˆ—ä¸åŒæ­¥

**ä¿®å¤åºåˆ—**ï¼š
```sql
SELECT setval('users_id_seq', (SELECT MAX(id) FROM users));
SELECT setval('projects_id_seq', (SELECT MAX(id) FROM projects));
```

---

## ğŸ¯ ä¸‹ä¸€æ­¥

- [ ] é…ç½®ç”Ÿäº§æ•°æ®åº“
- [ ] è®¾ç½®è‡ªåŠ¨å¤‡ä»½
- [ ] é…ç½®ç›‘æ§å‘Šè­¦
- [ ] å‹åŠ›æµ‹è¯•

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [PostgreSQL å®˜æ–¹æ–‡æ¡£](https://www.postgresql.org/docs/)
- [SQLAlchemy æ–‡æ¡£](https://docs.sqlalchemy.org/)
- [pgloader æ–‡æ¡£](https://pgloader.readthedocs.io/)
- [Supabase æ–‡æ¡£](https://supabase.com/docs)
